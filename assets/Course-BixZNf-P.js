import{q as L,a as U,u as M,v as $,r as c,s as z,a1 as O,dx as W,j as e,y,w as X,E as C,aO as q}from"./index-Dpx_N_gs.js";import{c as H}from"./index-C3jR5kAe.js";import{b7 as D}from"./Layout-D13wLvQL.js";import{V as G}from"./Video-mPKCpXj6.js";import{T as m}from"./index-Cer37cZd.js";import{P as J}from"./index-DuII0-jx.js";import{B as Q}from"./button-Bp-S57QA.js";import{R as Y,C as S}from"./row-BNKGYg9s.js";import{C as v}from"./index-CW1Ax-EF.js";import{E as I}from"./index-DaX2pSoY.js";import{C as Z}from"./Collapse-CDFtUy_i.js";import"./index-CK5Kkqrx.js";import"./EllipsisOutlined-baUkti0l.js";import"./Overflow-DQPmGoba.js";import"./context-D5_-vHka.js";import"./index-4Udo-fMr.js";import"./index-C1LBmv3z.js";import"./index-g7G_u2JW.js";import"./PurePanel-Bcv192SC.js";import"./CheckOutlined-Dunju1bI.js";import"./compact-item-DZdeyPT-.js";import"./SearchOutlined-ComhuVbi.js";import"./useLocale-DUxdT2ar.js";import"./Dropdown-DPsxu196.js";import"./index-BrEye_Nl.js";import"./index-DjDgpJ5R.js";import"./TextArea-BGhmzC-F.js";import"./index-DmZZNPzH.js";const Te=()=>{const w=L(),f=U(),{slug:k}=M(),{token:{colorPrimary:N}}=$.useToken(),T=c.useRef(null),g=c.useRef(null),{user:a}=z(t=>t.auth),{courses:u,status:B}=z(t=>t.cart),[x,K]=c.useState(!0),[o,A]=c.useState(null),[s,b]=c.useState(null);c.useState("");const h={videoRef:c.useRef(null),modulesRef:c.useRef(null),contentRef:c.useRef(null)},P=[{placement:"right",title:"Video khóa học!",description:"Xem video để hiểu rõ hơn về khóa học!",target:()=>h.videoRef.current},{placement:"left",title:"Học phần!",description:"Trong học phần có nhiều bài học, hãy chọn bài học để học!",target:()=>h.modulesRef.current},{placement:"top",title:"Nội dung và ghi chú bài học!",description:"Hãy đọc kỹ nội dung và ghi chú bài học để hiểu nhiều kiến thức hơn!",target:()=>h.contentRef.current}],R=c.useCallback((t,i,n)=>{const r=t==null?void 0:t.find(l=>l.slug===n);return(r==null?void 0:r._id)||null},[]),j=c.useCallback((t,i)=>{if(!(t!=null&&t.video)||!i)return null;const r=t.video.filter(l=>l.watched).sort((l,d)=>new Date(d.updatedAt)-new Date(l.updatedAt))[0];if(!r)return null;for(const l of i)for(const d of l.children)if(d._id===r.videoId)return{...d,watchTime:r.watchTime};return null},[]),_=c.useCallback((t,i)=>!(t!=null&&t.module)||!i?t:{...t,module:t.module.map(n=>({...n,children:n.children.map(r=>{const l=i.find(d=>d.videoId===r._id);return{...r,watchTime:l?l.watchTime:void 0,watched:!!l}})}))},[]),E=c.useCallback(()=>{var t;if((t=s==null?void 0:s.content)!=null&&t.css){const i=document.createElement("style");return i.textContent=s.content.css,document.head.appendChild(i),()=>{document.head.removeChild(i)}}},[s]),F=c.useCallback(()=>{var t,i;if((t=s==null?void 0:s.content)!=null&&t.js){const n=`
                (function() {
                    try {
                        ${s.content.js}
                    } catch (error) {
                        console.error('Error in lesson script:', error);
                    }
                })();
            `,r=document.createElement("script");return r.type="text/javascript",r.textContent=n,(i=g.current)==null||i.appendChild(r),()=>{var l;(l=g.current)!=null&&l.contains(r)&&g.current.removeChild(r)}}},[s]);c.useEffect(()=>{const t=E(),i=F();return()=>{t&&t(),i&&i()}},[s,E,F]),c.useEffect(()=>{B==="idle"&&w(O())},[w,B]),c.useEffect(()=>{(async()=>{if(!(a!=null&&a.courses)||!(u!=null&&u.newData))return;if(a.courses.length===0){f("/user/courses"),C("courses","Không thể xem khóa học!","Bạn chưa mua bất kỳ khóa học nào!");return}const i=R(u.newData,a.courses,k);if(!i){f("/user/courses"),C("courses","Không thể xem khóa học!","Khóa học không tồn tại hoặc bạn chưa mua khóa học này!");return}try{const n=await q.getModuleUser({id:i}),r=_(n,a.video),l=j(a,r.module);A(r),l!=null?b(j(a,r.module)):b(r.module[0].children[0]),K(!1)}catch(n){console.error("Error fetching course data:",n),C("courses","Lỗi","Không thể tải dữ liệu khóa học!")}})()},[a,u,f,k,R,_,j]),W(c.useCallback(()=>{(()=>{var n;const i=((n=T.current)==null?void 0:n.currentTime)||0;a!=null&&a._id&&(s!=null&&s._id)&&y.putVideo({id:a._id,videoId:s._id,watched:!0,watchTime:i}).catch(console.error)})()},[s,a]));const p=c.useMemo(()=>{var t;return(t=o==null?void 0:o.module)==null?void 0:t.map(i=>({key:i._id,label:e.jsx(m.Title,{level:5,strong:!0,className:"!mb-0",children:i.title}),extra:`${i.children.length} Bài Học`,children:i.children.map(n=>e.jsxs("div",{onClick:()=>{b(n),n!=null&&n.src&&y.putVideo({id:a==null?void 0:a._id,videoId:n==null?void 0:n._id,watched:!0})},className:"flex justify-between cursor-pointer",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[n!=null&&n.watched?e.jsx(H,{color:N,size:20}):e.jsx(H,{size:20}),e.jsx(m.Title,{level:5,className:"!mb-0 p-2",children:n.title})]}),(s==null?void 0:s._id)===n._id&&e.jsx(m.Text,{type:"danger",className:"!mb-0 p-2",children:(n==null?void 0:n.src)&&e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"1.2rem",height:"1.2rem",viewBox:"0 0 24 24",children:[e.jsxs("rect",{width:"6",height:"14",x:"1",y:"4",fill:"#ff0000",children:[e.jsx("animate",{id:"svgSpinnersBarsScaleFade0",fill:"freeze",attributeName:"y",begin:"0;svgSpinnersBarsScaleFade1.end-0.25s",dur:"0.75s",values:"1;5"}),e.jsx("animate",{fill:"freeze",attributeName:"height",begin:"0;svgSpinnersBarsScaleFade1.end-0.25s",dur:"0.75s",values:"22;14"}),e.jsx("animate",{fill:"freeze",attributeName:"opacity",begin:"0;svgSpinnersBarsScaleFade1.end-0.25s",dur:"0.75s",values:"1;0.2"})]}),e.jsxs("rect",{width:"6",height:"14",x:"9",y:"4",fill:"#ff0000",opacity:"0.4",children:[e.jsx("animate",{fill:"freeze",attributeName:"y",begin:"svgSpinnersBarsScaleFade0.begin+0.15s",dur:"0.75s",values:"1;5"}),e.jsx("animate",{fill:"freeze",attributeName:"height",begin:"svgSpinnersBarsScaleFade0.begin+0.15s",dur:"0.75s",values:"22;14"}),e.jsx("animate",{fill:"freeze",attributeName:"opacity",begin:"svgSpinnersBarsScaleFade0.begin+0.15s",dur:"0.75s",values:"1;0.2"})]}),e.jsxs("rect",{width:"6",height:"14",x:"17",y:"4",fill:"#ff0000",opacity:"0.3",children:[e.jsx("animate",{id:"svgSpinnersBarsScaleFade1",fill:"freeze",attributeName:"y",begin:"svgSpinnersBarsScaleFade0.begin+0.3s",dur:"0.75s",values:"1;5"}),e.jsx("animate",{fill:"freeze",attributeName:"height",begin:"svgSpinnersBarsScaleFade0.begin+0.3s",dur:"0.75s",values:"22;14"}),e.jsx("animate",{fill:"freeze",attributeName:"opacity",begin:"svgSpinnersBarsScaleFade0.begin+0.3s",dur:"0.75s",values:"1;0.2"})]})]})})]},n._id))}))},[o,N,s,a]);return e.jsx(D,{title:(o==null?void 0:o.name)||"Khóa học của tôi",tours:P,header:"KHÓA HỌC CỦA TÔI",button:e.jsx(e.Fragment,{children:e.jsx(J,{placement:"left",title:"Xác nhận học lại khóa học?",description:"Bạn có chắc chắn muốn học lại khóa học này không?",onConfirm:()=>{y.putUser({id:a==null?void 0:a._id,video:[]})},children:e.jsx(Q,{children:"Học Lại Khóa Học"})})}),children:e.jsxs(Y,{gutter:[24,24],children:[e.jsx(S,{xxl:16,xl:15,lg:14,md:24,span:24,children:e.jsx(v,{loading:x,title:e.jsx(m.Title,{level:3,className:"!mb-0",children:(o==null?void 0:o.name)||"Khóa học của tôi"}),ref:h.videoRef,className:"sticky",style:{top:"5rem"},children:s!=null&&s.src?e.jsx(G,{mediaPlayerRef:T,iduser:a==null?void 0:a._id,videoId:s._id,autoPlay:!0,time:s.watchTime,src:`${X}/uploads/${s.src}`}):e.jsx(I,{description:"Chưa có video được tải lên!"})})}),e.jsx(S,{xxl:8,xl:9,lg:10,md:24,span:24,children:e.jsx(v,{loading:x,title:e.jsx(m.Title,{level:3,className:"!mb-0",children:"Nội Dung Khóa Học"}),ref:h.modulesRef,children:e.jsx(Z,{expandIconPosition:"start",items:p,defaultActiveKey:p==null?void 0:p.map(t=>t.key)})})}),e.jsx(S,{span:24,children:e.jsx(v,{loading:x,ref:h.contentRef,className:"mb-6",title:e.jsxs(m.Title,{className:"!mb-0",level:3,children:["Bài Học ",s==null?void 0:s.title]}),children:s!=null&&s.content?e.jsx(e.Fragment,{children:e.jsx("div",{dangerouslySetInnerHTML:{__html:s.content.html}})}):e.jsx(I,{description:"Chưa có nội dung được tải lên!"})})})]})})};export{Te as default};
