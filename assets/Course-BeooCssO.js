import{a as H,u as A,v as I,r as l,s as K,ds as P,j as e,A as b,x as U,a4 as L,G as $}from"./index-BdOE-fa-.js";import{c as B}from"./index-BdswZ8-c.js";import{b7 as M}from"./Layout-gyxonnrQ.js";import{V as W}from"./Video-BWhG4Ejp.js";import{T as m}from"./index-jIgmwNNp.js";import{P as X}from"./index-kFGcBh7s.js";import{B as G}from"./button-CvCmxs8T.js";import{R as O,C as y}from"./row-D1ZbnJUK.js";import{C}from"./index-CbfWO4j0.js";import{E as R}from"./index-CDOktMju.js";import{C as q}from"./Collapse-DiBB1qMH.js";import"./index-AlgY4fWc.js";import"./EllipsisOutlined-BvA6wDAr.js";import"./Overflow-DVPExx9Z.js";import"./context-C8X7ZTB_.js";import"./index-BDgQvzKh.js";import"./index-CL9n5M5P.js";import"./index-CqycG0zr.js";import"./PurePanel-D_I_Uezm.js";import"./CheckOutlined-DcZFIb24.js";import"./compact-item-BegTVyII.js";import"./SearchOutlined-8OVsOvsk.js";import"./useLocale-Dm4XDbKC.js";import"./Dropdown-DFXza65X.js";import"./index-CntKCOEE.js";import"./index-CJwemZo-.js";import"./TextArea-DhjeoYlA.js";import"./index-Dioc4UUc.js";const Se=()=>{const S=H(),{slug:u}=A(),{token:{colorPrimary:v}}=I.useToken(),w=l.useRef(null),f=l.useRef(null),{user:a}=K(t=>t.auth),[g,_]=l.useState(!0),[o,F]=l.useState(null),[s,x]=l.useState(null),d={videoRef:l.useRef(null),modulesRef:l.useRef(null),contentRef:l.useRef(null)},E=[{placement:"right",title:"Video khóa học!",description:"Xem video để hiểu rõ hơn về khóa học!",target:()=>d.videoRef.current},{placement:"left",title:"Học phần!",description:"Trong học phần có nhiều bài học, hãy chọn bài học để học!",target:()=>d.modulesRef.current},{placement:"top",title:"Nội dung và ghi chú bài học!",description:"Hãy đọc kỹ nội dung và ghi chú bài học để hiểu nhiều kiến thức hơn!",target:()=>d.contentRef.current}],z=l.useCallback((t,n,i)=>{const r=t==null?void 0:t.find(c=>c.slug===i);return(r==null?void 0:r._id)||null},[]),j=l.useCallback((t,n)=>{if(!(t!=null&&t.video)||!n)return null;const r=t.video.filter(c=>c.watched).sort((c,h)=>new Date(h.updatedAt)-new Date(c.updatedAt))[0];if(!r)return null;for(const c of n)for(const h of c.children)if(h._id===r.videoId)return{...h,watchTime:r.watchTime};return null},[]),k=l.useCallback((t,n)=>!(t!=null&&t.module)||!n?t:{...t,module:t.module.map(i=>({...i,children:i.children.map(r=>{const c=n.find(h=>h.videoId===r._id);return{...r,watchTime:c?c.watchTime:void 0,watched:!!c}})}))},[]),N=l.useCallback(()=>{var t;if((t=s==null?void 0:s.content)!=null&&t.css){const n=document.createElement("style");return n.textContent=s.content.css,document.head.appendChild(n),()=>{document.head.removeChild(n)}}},[s]),T=l.useCallback(()=>{var t,n;if((t=s==null?void 0:s.content)!=null&&t.js){const i=`
                (function() {
                    try {
                        ${s.content.js}
                    } catch (error) {
                        console.error('Error in lesson script:', error);
                    }
                })();
            `,r=document.createElement("script");return r.type="text/javascript",r.textContent=i,(n=f.current)==null||n.appendChild(r),()=>{var c;(c=f.current)!=null&&c.contains(r)&&f.current.removeChild(r)}}},[s]);l.useEffect(()=>{const t=N(),n=T();return()=>{t&&t(),n&&n()}},[s,N,T]),l.useEffect(()=>{const t=async()=>{try{const n=await L.checkCourseUser({idUser:a._id,slugCourse:u}),i=k(n,a.video),r=j(a,i.module);F(i),r!=null?x(j(a,i.module)):x(i.module[0].children[0]),_(!1)}catch{S("/user/courses"),$("courses","Không thể xem khóa học!","Khóa học không tồn tại hoặc bạn chưa mua khóa học này!")}};a!=null&&a._id&&u&&t()},[a,S,u,z,k,j]),P(l.useCallback(()=>{(()=>{var i;const n=((i=w.current)==null?void 0:i.currentTime)||0;a!=null&&a._id&&(s!=null&&s._id)&&b.putVideo({id:a._id,videoId:s._id,watched:!0,watchTime:n}).catch(console.error)})()},[s,a]));const p=l.useMemo(()=>{var t;return(t=o==null?void 0:o.module)==null?void 0:t.map(n=>({key:n._id,label:e.jsx(m.Title,{level:5,strong:!0,className:"!mb-0",children:n.title}),extra:`${n.children.length} Bài Học`,children:n.children.map(i=>e.jsxs("div",{onClick:()=>{x(i),i!=null&&i.src&&b.putVideo({id:a==null?void 0:a._id,videoId:i==null?void 0:i._id,watched:!0})},className:"flex justify-between cursor-pointer",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[i!=null&&i.watched?e.jsx(B,{color:v,size:20}):e.jsx(B,{size:20}),e.jsx(m.Title,{level:5,className:"!mb-0 p-2",children:i.title})]}),(s==null?void 0:s._id)===i._id&&e.jsx(m.Text,{type:"danger",className:"!mb-0 p-2",children:(i==null?void 0:i.src)&&e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"1.2rem",height:"1.2rem",viewBox:"0 0 24 24",children:[e.jsxs("rect",{width:"6",height:"14",x:"1",y:"4",fill:"#ff0000",children:[e.jsx("animate",{id:"svgSpinnersBarsScaleFade0",fill:"freeze",attributeName:"y",begin:"0;svgSpinnersBarsScaleFade1.end-0.25s",dur:"0.75s",values:"1;5"}),e.jsx("animate",{fill:"freeze",attributeName:"height",begin:"0;svgSpinnersBarsScaleFade1.end-0.25s",dur:"0.75s",values:"22;14"}),e.jsx("animate",{fill:"freeze",attributeName:"opacity",begin:"0;svgSpinnersBarsScaleFade1.end-0.25s",dur:"0.75s",values:"1;0.2"})]}),e.jsxs("rect",{width:"6",height:"14",x:"9",y:"4",fill:"#ff0000",opacity:"0.4",children:[e.jsx("animate",{fill:"freeze",attributeName:"y",begin:"svgSpinnersBarsScaleFade0.begin+0.15s",dur:"0.75s",values:"1;5"}),e.jsx("animate",{fill:"freeze",attributeName:"height",begin:"svgSpinnersBarsScaleFade0.begin+0.15s",dur:"0.75s",values:"22;14"}),e.jsx("animate",{fill:"freeze",attributeName:"opacity",begin:"svgSpinnersBarsScaleFade0.begin+0.15s",dur:"0.75s",values:"1;0.2"})]}),e.jsxs("rect",{width:"6",height:"14",x:"17",y:"4",fill:"#ff0000",opacity:"0.3",children:[e.jsx("animate",{id:"svgSpinnersBarsScaleFade1",fill:"freeze",attributeName:"y",begin:"svgSpinnersBarsScaleFade0.begin+0.3s",dur:"0.75s",values:"1;5"}),e.jsx("animate",{fill:"freeze",attributeName:"height",begin:"svgSpinnersBarsScaleFade0.begin+0.3s",dur:"0.75s",values:"22;14"}),e.jsx("animate",{fill:"freeze",attributeName:"opacity",begin:"svgSpinnersBarsScaleFade0.begin+0.3s",dur:"0.75s",values:"1;0.2"})]})]})})]},i._id))}))},[o,v,s,a]);return e.jsx(M,{title:(o==null?void 0:o.name)||"Khóa học của tôi",tours:E,header:"KHÓA HỌC CỦA TÔI",button:e.jsx(e.Fragment,{children:e.jsx(X,{placement:"left",title:"Xác nhận học lại khóa học?",description:"Bạn có chắc chắn muốn học lại khóa học này không?",onConfirm:()=>{b.putUser({id:a==null?void 0:a._id,video:[]})},children:e.jsx(G,{children:"Học Lại Khóa Học"})})}),children:e.jsxs(O,{gutter:[24,24],children:[e.jsx(y,{xxl:16,xl:15,lg:14,md:24,span:24,children:e.jsx(C,{loading:g,title:e.jsx(m.Title,{level:3,className:"!mb-0",children:(o==null?void 0:o.name)||"Khóa học của tôi"}),ref:d.videoRef,className:"sticky",style:{top:"5rem"},children:s!=null&&s.src?e.jsx(W,{mediaPlayerRef:w,iduser:a==null?void 0:a._id,videoId:s._id,autoPlay:!0,time:s.watchTime,src:`${U}/uploads/${s.src}`}):e.jsx(R,{description:"Chưa có video được tải lên!"})})}),e.jsx(y,{xxl:8,xl:9,lg:10,md:24,span:24,children:e.jsx(C,{loading:g,title:e.jsx(m.Title,{level:3,className:"!mb-0",children:"Nội Dung Khóa Học"}),ref:d.modulesRef,children:e.jsx(q,{expandIconPosition:"start",items:p,defaultActiveKey:p==null?void 0:p.map(t=>t.key)})})}),e.jsx(y,{span:24,children:e.jsx(C,{loading:g,ref:d.contentRef,className:"mb-6",title:e.jsxs(m.Title,{className:"!mb-0",level:3,children:["Bài Học ",s==null?void 0:s.title]}),children:s!=null&&s.content?e.jsx(e.Fragment,{children:e.jsx("div",{dangerouslySetInnerHTML:{__html:s.content.html}})}):e.jsx(R,{description:"Chưa có nội dung được tải lên!"})})})]})})};export{Se as default};
